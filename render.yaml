# ===================================================
# Yakuniy, Tuzatilgan va To'liq Ishlaydigan render.yaml
# ===================================================

# 1. Ma'lumotlar bazasini aniqlash
databases:
  - name: tabletmenu-db
    databaseName: tabletmenu
    user: tabletmenu_user

# 2. Xizmatlarni aniqlash
services:
  # 2.1. Frontend Xizmati (React ilovasi)
  - type: web
    name: tabletmenu-frontend
    env: static
    rootDir: ./
    buildCommand: npm install && npm run build
    staticPublishPath: ./dist
    routes:
      # Birinchi qoida: API so'rovlari uchun Reverse Proxy
      # /api/ bilan boshlangan so'rovni backend xizmatiga yo'naltiradi.
      - type: rewrite
        source: /api/:path*
        destination: /api/:path* # Backend'dagi yo'l o'zgarishsiz qoladi
        service: # Qaysi xizmatga yuborish kerakligi shu yerda ko'rsatiladi
          name: tabletmenu-backend
          type: web

      # Ikkinchi qoida: SPA uchun umumiy yo'naltirish
      # Boshqa har qanday so'rovni index.html'ga yuboradi.
      - type: rewrite
        source: /*
        destination: /index.html

  # 2.2. Backend Xizmati (Node.js API serveri)
  - type: web
    name: tabletmenu-backend
    env: node
    rootDir: ./server
    buildCommand: npm install
    startCommand: node index.js
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: tabletmenu-db
          property: connectionString
